<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Postural Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            overflow-x: hidden;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6);
            text-align: center;
            margin-bottom: 2rem;
        }
        video {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid #d4af37;
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.4);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            object-fit: cover;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        video:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.6);
        }
        canvas {
            border: 4px solid #a0aec0;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 960px;
            height: auto;
            background: #2d3748;
            margin: 0 auto;
            display: block;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .premium-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 15px;
            padding: 2rem;
            border-left: 6px solid #d4af37;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(212, 175, 55, 0.5);
        }
        .status-incorrect {
            color: #ff4d4d;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        .status-correct {
            color: #4ade80;
            font-weight: 600;
        }
        .severity-acceptable {
            color: #4ade80;
        }
        .severity-faible {
            color: #ffeb3b;
        }
        .severity-eleve {
            color: #ff9800;
        }
        .severity-tresEleve {
            color: #ff4d4d;
        }
        button {
            background: linear-gradient(90deg, #d4af37 0%, #c0a062 100%);
            color: #1a202c;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(90deg, #c0a062 0%, #d4af37 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.5);
        }
        select {
            background: #2d3748;
            color: #e2e8f0;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        select:hover {
            background: #4a5568;
        }
        .personal-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .personal-info img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #d4af37;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            overflow-y: auto;
            padding: 2rem;
        }
        .modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 15px;
            border: 4px solid #d4af37;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-content h2 {
            color: #ffd700;
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }
        .modal-content th, .modal-content td {
            padding: 0.75rem;
            border: 2px solid #d4af37;
            text-align: left;
            color: #e2e8f0;
        }
        .modal-content th {
            background: #4a5568;
            font-weight: 600;
        }
        .modal-content .close-button {
            background: #ff4d4d;
            color: #fff;
            margin-top: 1rem;
        }
        .modal-content .close-button:hover {
            background: #e53e3e;
            transform: translateY(-3px);
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            canvas {
                max-width: 100%;
            }
            video {
                width: 120px;
                height: 120px;
                top: 10px;
                right: 10px;
            }
            h1 {
                font-size: 2.25rem;
            }
            .personal-info {
                flex-direction: column;
                align-items: center;
            }
            .personal-info img {
                width: 100px;
                height: 100px;
            }
            .modal-content {
                margin: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <h1 id="title">Advanced Postural Analysis System</h1>
    <div class="container">
        <div class="personal-info premium-card">
            <img src="https://raw.githubusercontent.com/oussamaachahbar/posture/main/Capture.JPG" alt="User's Photo">
            <button id="personalButton">KAMAL MOUJOUD</button>
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="ar">العربية</option>
            </select>
        </div>
        <div id="analyseView" class="relative">
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
            <div class="flex gap-4 flex-wrap justify-center mt-6">
                <button id="startButton" onclick="startAnalysis()">Start Analysis</button>
                <button id="switchButton" onclick="switchCamera()">Switch Camera</button>
                <button id="tableButton" onclick="showRiskTables()">Table</button>
            </div>
            <div id="analysis" class="premium-card mt-6">
                <p class="text-lg font-semibold" id="postureStatusLabel">Postural Status: <span id="postureStatus">Waiting for analysis...</span></p>
                <div id="postureDetails" class="hidden mt-4">
                    <p class="text-lg font-semibold text-yellow-400" id="feedbackLabel">Posture Feedback:</p>
                    <ul id="postureList" class="list-disc list-inside mt-2"></ul>
                </div>
            </div>
        </div>
    </div>
    <div id="riskModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Risk Levels and Solutions</h2>
            <div id="riskTables"></div>
            <button class="close-button" onclick="closeRiskModal()">Close</button>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                title: "Advanced Postural Analysis System",
                startButton: "Start Analysis",
                switchButton: "Switch Camera",
                tableButton: "Table",
                modalTitle: "Risk Levels and Solutions",
                postureStatusLabel: "Postural Status: ",
                feedbackLabel: "Posture Feedback:",
                severityLevel: "Severity Level",
                waiting: "Waiting for analysis...",
                analyzing: "Analyzing posture...",
                noPerson: "No person detected",
                components: {
                    head: "Head",
                    neck: "Neck",
                    shoulders: "Shoulders",
                    arms: "Arms",
                    forearms: "Forearms",
                    wrists: "Wrists",
                    hands: "Hands",
                    back: "Back",
                    pelvis: "Pelvis",
                    thighs: "Thighs",
                    knees: "Knees",
                    feet: "Feet"
                },
                details: {
                    headForward: "Head tilted forward beyond 20°",
                    headMisaligned: "Head not aligned with torso",
                    neckTilted: "Neck tilted or flexed excessively",
                    neckTwisted: "Neck twisted",
                    shouldersRaised: "Shoulders raised or tense",
                    shouldersAbove: "Arms above shoulder line",
                    armsExtended: "Arms excessively extended forward",
                    armAngleIncorrect: "Arm-forearm angle not between 90-110°",
                    forearmsNotHorizontal: "Forearms not horizontal or slightly inclined",
                    forearmsSuspended: "Forearms suspended without support",
                    wristsNotNeutral: "Wrists not aligned with forearms",
                    wristsFlexed: "Wrists flexed excessively",
                    handsTense: "Hands tense or fingers cramped",
                    backForward: "Back tilted forward beyond 20°",
                    backTwisted: "Back twisted",
                    pelvisMisaligned: "Pelvis not aligned with torso",
                    thighsNotHorizontal: "Thighs not horizontal when seated",
                    thighsLocked: "Thighs locked when standing",
                    kneesNot90: "Knees not at 90° when seated",
                    kneesLocked: "Knees locked when standing",
                    feetNotFlat: "Feet not flat on the ground",
                    feetCrossed: "Feet crossed or on tiptoes",
                    correct: "Correct position",
                    severity: {
                        acceptable: " (Acceptable)",
                        faible: " (Low)",
                        eleve: " (High)",
                        tresEleve: " (Very High)"
                    }
                },
                solutions: {
                    head: {
                        acceptable: "Maintain current head position, keeping it aligned with the spine.",
                        faible: "Adjust head slightly to align with the spine and avoid forward tilt.",
                        eleve: "Reposition head to be directly above shoulders, avoid leaning forward.",
                        tresEleve: "Urgently correct head position, consult a posture specialist if persistent."
                    },
                    neck: {
                        acceptable: "Keep neck relaxed and aligned with the spine.",
                        faible: "Gently straighten neck to reduce tilt or twist.",
                        eleve: "Correct neck alignment by keeping it in line with the spine, avoid twisting.",
                        tresEleve: "Immediately adjust neck position, consider ergonomic support or professional advice."
                    },
                    shoulders: {
                        acceptable: "Maintain relaxed shoulders at an even height.",
                        faible: "Lower shoulders slightly and keep them relaxed.",
                        eleve: "Adjust shoulders to be level and relaxed, avoid raising or tensing.",
                        tresEleve: "Urgently relax and level shoulders, consider physical therapy if needed."
                    },
                    arms: {
                        acceptable: "Keep arms at a comfortable 90-110° angle.",
                        faible: "Adjust arm position to maintain a 90-110° angle with forearms.",
                        eleve: "Reposition arms to avoid excessive extension or elevation.",
                        tresEleve: "Correct arm positioning immediately, use armrests for support."
                    },
                    forearms: {
                        acceptable: "Maintain forearms horizontal or slightly inclined with support.",
                        faible: "Slightly adjust forearms to be horizontal and supported.",
                        eleve: "Reposition forearms to rest on a surface, avoid suspension.",
                        tresEleve: "Urgently adjust forearms to a supported, horizontal position."
                    },
                    wrists: {
                        acceptable: "Keep wrists neutral and aligned with forearms.",
                        faible: "Adjust wrists to maintain a neutral position.",
                        eleve: "Correct wrist alignment to avoid excessive flexion.",
                        tresEleve: "Immediately reposition wrists to neutral, consider wrist supports."
                    },
                    hands: {
                        acceptable: "Keep hands relaxed with fingers at ease.",
                        faible: "Relax hands to reduce tension in fingers.",
                        eleve: "Adjust hand position to avoid cramping or tension.",
                        tresEleve: "Urgently relax hands, consider ergonomic tools or consultation."
                    },
                    back: {
                        acceptable: "Maintain a straight back aligned with the pelvis.",
                        faible: "Straighten back slightly to align with the pelvis.",
                        eleve: "Correct back posture to avoid forward tilt or twisting.",
                        tresEleve: "Immediately straighten back, consider lumbar support or professional help."
                    },
                    pelvis: {
                        acceptable: "Keep pelvis aligned with the torso.",
                        faible: "Adjust pelvis slightly to align with the torso.",
                        eleve: "Reposition pelvis to maintain alignment with the spine.",
                        tresEleve: "Urgently correct pelvis alignment, consider ergonomic seating."
                    },
                    thighs: {
                        acceptable: "Maintain thighs horizontal when seated.",
                        faible: "Adjust thighs to be more horizontal when seated.",
                        eleve: "Reposition thighs to ensure they are horizontal and supported.",
                        tresEleve: "Immediately adjust thigh position, use proper seating support."
                    },
                    knees: {
                        acceptable: "Keep knees at a 90° angle when seated.",
                        faible: "Adjust knees slightly to maintain a 90° angle.",
                        eleve: "Reposition knees to achieve a 90° angle when seated.",
                        tresEleve: "Urgently correct knee angle, ensure proper seat height."
                    },
                    feet: {
                        acceptable: "Keep feet flat on the ground, not crossed.",
                        faible: "Adjust feet to be flat on the ground, avoid crossing.",
                        eleve: "Reposition feet to ensure they are flat and uncrossed.",
                        tresEleve: "Immediately place feet flat on the ground, use a footrest if needed."
                    }
                }
            },
            fr: {
                title: "Système Avancé d'Analyse Posturale",
                startButton: "Démarrer l'Analyse",
                switchButton: "Changer de Caméra",
                tableButton: "Tableau",
                modalTitle: "Niveaux de Risque et Solutions",
                postureStatusLabel: "État de la Posture : ",
                feedbackLabel: "Retour sur la Posture :",
                severityLevel: "Niveau de Gravité",
                waiting: "En attente d'analyse...",
                analyzing: "Analyse de la posture...",
                noPerson: "Aucune personne détectée",
                components: {
                    head: "Tête",
                    neck: "Cou",
                    shoulders: "Épaules",
                    arms: "Bras",
                    forearms: "Avant-bras",
                    wrists: "Poignets",
                    hands: "Mains",
                    back: "Dos",
                    pelvis: "Bassin",
                    thighs: "Cuisses",
                    knees: "Genoux",
                    feet: "Pieds"
                },
                details: {
                    headForward: "Tête penchée vers l'avant au-delà de 20°",
                    headMisaligned: "Tête non alignée avec le tronc",
                    neckTilted: "Cou incliné ou fléchi excessivement",
                    neckTwisted: "Cou tordu",
                    shouldersRaised: "Épaules relevées ou tendues",
                    shouldersAbove: "Bras au-dessus de la ligne des épaules",
                    armsExtended: "Bras trop étendus vers l'avant",
                    armAngleIncorrect: "Angle bras-avant-bras non compris entre 90-110°",
                    forearmsNotHorizontal: "Avant-bras non horizontaux ou légèrement inclinés",
                    forearmsSuspended: "Avant-bras suspendus sans support",
                    wristsNotNeutral: "Poignets non alignés avec les avant-bras",
                    wristsFlexed: "Poignets fléchis excessivement",
                    handsTense: "Mains tendues ou doigts crispés",
                    backForward: "Dos incliné vers l'avant au-delà de 20°",
                    backTwisted: "Dos tordu",
                    pelvisMisaligned: "Bassin non aligné avec le tronc",
                    thighsNotHorizontal: "Cuisses non horizontales en position assise",
                    thighsLocked: "Cuisses verrouillées en position debout",
                    kneesNot90: "Genoux non à 90° en position assise",
                    kneesLocked: "Genoux verrouillés en position debout",
                    feetNotFlat: "Pieds non à plat sur le sol",
                    feetCrossed: "Pieds croisés ou sur la pointe",
                    correct: "Position correcte",
                    severity: {
                        acceptable: " (Acceptable)",
                        faible: " (Faible)",
                        eleve: " (Élevé)",
                        tresEleve: " (Très Élevé)"
                    }
                },
                solutions: {
                    head: {
                        acceptable: "Maintenir la position actuelle de la tête, alignée avec la colonne vertébrale.",
                        faible: "Ajuster légèrement la tête pour l'aligner avec la colonne et éviter l'inclinaison vers l'avant.",
                        eleve: "Repositionner la tête directement au-dessus des épaules, éviter de pencher en avant.",
                        tresEleve: "Corriger immédiatement la position de la tête, consulter un spécialiste de la posture si persistant."
                    },
                    neck: {
                        acceptable: "Garder le cou détendu et aligné avec la colonne vertébrale.",
                        faible: "Redresser doucement le cou pour réduire l'inclinaison ou la torsion.",
                        eleve: "Corriger l'alignement du cou en le maintenant en ligne avec la colonne, éviter la torsion.",
                        tresEleve: "Ajuster immédiatement la position du cou, envisager un soutien ergonomique ou des conseils professionnels."
                    },
                    shoulders: {
                        acceptable: "Maintenir les épaules détendues à une hauteur égale.",
                        faible: "Abaisser légèrement les épaules et les garder détendues.",
                        eleve: "Ajuster les épaules pour qu'elles soient de niveau et détendues, éviter de les relever ou de les tendre.",
                        tresEleve: "Détendre et niveler les épaules de toute urgence, envisager une thérapie physique si nécessaire."
                    },
                    arms: {
                        acceptable: "Maintenir les bras à un angle confortable de 90-110°.",
                        faible: "Ajuster la position des bras pour maintenir un angle de 90-110° avec les avant-bras.",
                        eleve: "Repositionner les bras pour éviter une extension ou une élévation excessive.",
                        tresEleve: "Corriger immédiatement la position des bras, utiliser des accoudoirs pour le soutien."
                    },
                    forearms: {
                        acceptable: "Maintenir les avant-bras horizontaux ou légèrement inclinés avec un soutien.",
                        faible: "Ajuster légèrement les avant-bras pour qu'ils soient horizontaux et soutenus.",
                        eleve: "Repositionner les avant-bras pour qu'ils reposent sur une surface, éviter la suspension.",
                        tresEleve: "Ajuster de toute urgence les avant-bras à une position horizontale soutenue."
                    },
                    wrists: {
                        acceptable: "Maintenir les poignets neutres et alignés avec les avant-bras.",
                        faible: "Ajuster les poignets pour maintenir une position neutre.",
                        eleve: "Corriger l'alignement des poignets pour éviter une flexion excessive.",
                        tresEleve: "Repositionner immédiatement les poignets à une position neutre, envisager des supports pour poignets."
                    },
                    hands: {
                        acceptable: "Garder les mains détendues avec les doigts à l'aise.",
                        faible: "Détendre les mains pour réduire la tension dans les doigts.",
                        eleve: "Ajuster la position des mains pour éviter les crampes ou la tension.",
                        tresEleve: "Détendre immédiatement les mains, envisager des outils ergonomiques ou une consultation."
                    },
                    back: {
                        acceptable: "Maintenir un dos droit aligné avec le bassin.",
                        faible: "Redresser légèrement le dos pour l'aligner avec le bassin.",
                        eleve: "Corriger la posture du dos pour éviter l'inclinaison vers l'avant ou la torsion.",
                        tresEleve: "Redresser immédiatement le dos, envisager un soutien lombaire ou une aide professionnelle."
                    },
                    pelvis: {
                        acceptable: "Maintenir le bassin aligné avec le tronc.",
                        faible: "Ajuster légèrement le bassin pour l'aligner avec le tronc.",
                        eleve: "Repositionner le bassin pour maintenir l'alignement avec la colonne vertébrale.",
                        tresEleve: "Corriger de toute urgence l'alignement du bassin, envisager un siège ergonomique."
                    },
                    thighs: {
                        acceptable: "Maintenir les cuisses horizontales en position assise.",
                        faible: "Ajuster les cuisses pour qu'elles soient plus horizontales en position assise.",
                        eleve: "Repositionner les cuisses pour s'assurer qu'elles sont horizontales et soutenues.",
                        tresEleve: "Ajuster immédiatement la position des cuisses, utiliser un soutien d'assise approprié."
                    },
                    knees: {
                        acceptable: "Maintenir les genoux à un angle de 90° en position assise.",
                        faible: "Ajuster légèrement les genoux pour maintenir un angle de 90°.",
                        eleve: "Repositionner les genoux pour atteindre un angle de 90° en position assise.",
                        tresEleve: "Corriger de toute urgence l'angle des genoux, s'assurer de la bonne hauteur de siège."
                    },
                    feet: {
                        acceptable: "Maintenir les pieds à plat sur le sol, non croisés.",
                        faible: "Ajuster les pieds pour qu'ils soient à plat sur le sol, éviter de les croiser.",
                        eleve: "Repositionner les pieds pour s'assurer qu'ils sont à plat et non croisés.",
                        tresEleve: "Placer immédiatement les pieds à plat sur le sol, utiliser un repose-pieds si nécessaire."
                    }
                }
            },
            ar: {
                title: "نظام تحليل الوضعية المتقدم",
                startButton: "بدء التحليل",
                switchButton: "تبديل الكاميرا",
                tableButton: "جدول",
                modalTitle: "مستويات المخاطر والحلول",
                postureStatusLabel: "حالة الوضعية: ",
                feedbackLabel: "تعليقات الوضعية:",
                severityLevel: "مستوى الخطورة",
                waiting: "في انتظار التحليل...",
                analyzing: "جارٍ تحليل الوضعية...",
                noPerson: "لم يتم اكتشاف أي شخص",
                components: {
                    head: "الرأس",
                    neck: "الرقبة",
                    shoulders: "الأكتاف",
                    arms: "الذراعان",
                    forearms: "الساعدان",
                    wrists: "المعصمان",
                    hands: "اليدان",
                    back: "الظهر",
                    pelvis: "الحوض",
                    thighs: "الفخذان",
                    knees: "الركبتان",
                    feet: "القدمان"
                },
                details: {
                    headForward: "الرأس مائل للأمام أكثر من 20 درجة",
                    headMisaligned: "الرأس غير محاذٍ للجذع",
                    neckTilted: "الرقبة مائلة أو مثنية بشكل مفرط",
                    neckTwisted: "الرقبة ملتوية",
                    shouldersRaised: "الأكتاف مرفوعة أو مشدودة",
                    shouldersAbove: "الذراعان فوق خط الأكتاف",
                    armsExtended: "الذراعان ممتدان للأمام بشكل مفرط",
                    armAngleIncorrect: "زاوية الذراع-الساعد ليست بين 90-110 درجات",
                    forearmsNotHorizontal: "الساعدان غير أفقيين أو مائلين قليلاً",
                    forearmsSuspended: "الساعدان معلقان بدون دعم",
                    wristsNotNeutral: "المعصمان غير محاذيين للساعدين",
                    wristsFlexed: "المعصمان مثنيان بشكل مفرط",
                    handsTense: "اليدان مشدودتان أو الأصابع متشنجة",
                    backForward: "الظهر مائل للأمام أكثر من 20 درجة",
                    backTwisted: "الظهر ملتوي",
                    pelvisMisaligned: "الحوض غير محاذٍ للجذع",
                    thighsNotHorizontal: "الفخذان غير أفقيين عند الجلوس",
                    thighsLocked: "الفخذان مقفلان عند الوقوف",
                    kneesNot90: "الركبتان ليستا بزاوية 90 درجة عند الجلوس",
                    kneesLocked: "الركبتان مقفلتان عند الوقوف",
                    feetNotFlat: "القدمان ليستا مسطحتين على الأرض",
                    feetCrossed: "القدمان متقاطعتان أو على أطراف الأصابع",
                    correct: "الوضعية صحيحة",
                    severity: {
                        acceptable: " (مقبول)",
                        faible: " (ضعيف)",
                        eleve: " (مرتفع)",
                        tresEleve: " (عالٍ جدًا)"
                    }
                },
                solutions: {
                    head: {
                        acceptable: "الحفاظ على وضعية الرأس الحالية، مع الحفاظ على محاذاتها مع العمود الفقري.",
                        faible: "ضبط الرأس قليلاً لمحاذاته مع العمود الفقري وتجنب الميل للأمام.",
                        eleve: "إعادة وضع الرأس مباشرة فوق الأكتاف، تجنب الميل للأمام.",
                        tresEleve: "تصحيح وضعية الرأس فورًا، استشارة أخصائي الوضعية إذا استمرت."
                    },
                    neck: {
                        acceptable: "الحفاظ على الرقبة مسترخية ومحاذية للعمود الفقري.",
                        faible: "تصحيح الرقبة بلطف لتقليل الميل أو الالتواء.",
                        eleve: "تصحيح محاذاة الرقبة لتكون في خط مع العمود الفقري، تجنب الالتواء.",
                        tresEleve: "ضبط وضعية الرقبة فورًا، التفكير في دعم مريح أو استشارة مهنية."
                    },
                    shoulders: {
                        acceptable: "الحفاظ على الأكتاف مسترخية وعلى ارتفاع متساوٍ.",
                        faible: "خفض الأكتاف قليلاً والحفاظ عليها مسترخية.",
                        eleve: "ضبط الأكتاف لتكون متساوية ومسترخية، تجنب رفعها أو توترها.",
                        tresEleve: "إرخاء الأكتاف وتسويتها بشكل عاجل، التفكير في العلاج الطبيعي إذا لزم الأمر."
                    },
                    arms: {
                        acceptable: "الحفاظ على الذراعين بزاوية مريحة بين 90-110 درجات.",
                        faible: "ضبط وضعية الذراعين للحفاظ على زاوية 90-110 درجات مع الساعدين.",
                        eleve: "إعادة وضع الذراعين لتجنب التمدد أو الرفع الزائد.",
                        tresEleve: "تصحيح وضعية الذراعين فورًا، استخدام مساند الذراع للدعم."
                    },
                    forearms: {
                        acceptable: "الحفاظ على الساعدين أفقيين أو مائلين قليلاً مع الدعم.",
                        faible: "ضبط الساعدين قليلاً ليكونا أفقيين ومدعومين.",
                        eleve: "إعادة وضع الساعدين ليستقرا على سطح، تجنب التعليق.",
                        tresEleve: "ضبط الساعدين فورًا إلى وضعية أفقية مدعومة."
                    },
                    wrists: {
                        acceptable: "الحفاظ على المعصمين في وضع محايد ومحاذيين للساعدين.",
                        faible: "ضبط المعصمين للحفاظ على وضعية محايدة.",
                        eleve: "تصحيح محاذاة المعصمين لتجنب الانثناء الزائد.",
                        tresEleve: "إعادة وضع المعصمين فورًا إلى وضع محايد، التفكير في دعامات المعصم."
                    },
                    hands: {
                        acceptable: "الحفاظ على اليدين مسترخيتين مع أصابع مرتاحة.",
                        faible: "إرخاء اليدين لتقليل التوتر في الأصابع.",
                        eleve: "ضبط وضعية اليدين لتجنب التشنج أو التوتر.",
                        tresEleve: "إرخاء اليدين فورًا، التفكير في أدوات مريحة أو استشارة."
                    },
                    back: {
                        acceptable: "الحفاظ على ظهر مستقيم محاذٍ للحوض.",
                        faible: "تصحيح الظهر قليلاً لمحاذاته مع الحوض.",
                        eleve: "تصحيح وضعية الظهر لتجنب الميل للأمام أو الالتواء.",
                        tresEleve: "تصحيح الظهر فورًا، التفكير في دعم قطني أو مساعدة مهنية."
                    },
                    pelvis: {
                        acceptable: "الحفاظ على الحوض محاذٍ للجذع.",
                        faible: "ضبط الحوض قليلاً لمحاذاته مع الجذع.",
                        eleve: "إعادة وضع الحوض للحفاظ على المحاذاة مع العمود الفقري.",
                        tresEleve: "تصحيح محاذاة الحوض فورًا، التفكير في مقعد مريح."
                    },
                    thighs: {
                        acceptable: "الحفاظ على الفخذين أفقيين عند الجلوس.",
                        faible: "ضبط الفخذين لتكون أكثر أفقية عند الجلوس.",
                        eleve: "إعادة وضع الفخذين للتأكد من أنها أفقية ومدعومة.",
                        tresEleve: "ضبط وضعية الفخذين فورًا، استخدام دعم مقعد مناسب."
                    },
                    knees: {
                        acceptable: "الحفاظ على الركبتين بزاوية 90 درجة عند الجلوس.",
                        faible: "ضبط الركبتين قليلاً للحفاظ على زاوية 90 درجة.",
                        eleve: "إعادة وضع الركبتين لتحقيق زاوية 90 درجة عند الجلوس.",
                        tresEleve: "تصحيح زاوية الركبتين فورًا، التأكد من ارتفاع المقعد المناسب."
                    },
                    feet: {
                        acceptable: "الحفاظ على القدمين مسطحتين على الأرض، غير متقاطعتين.",
                        faible: "ضبط القدمين لتكون مسطحتين على الأرض، تجنب التقاطع.",
                        eleve: "إعادة وضع القدمين للتأكد من أنها مسطحة وغير متقاطعة.",
                        tresEleve: "وضع القدمين مسطحتين على الأرض فورًا، استخدام مسند قدم إذا لزم الأمر."
                    }
                }
            }
        };

        let currentLanguage = 'en';

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            const t = translations[currentLanguage];
            document.getElementById('title').textContent = t.title;
            document.getElementById('startButton').textContent = t.startButton;
            document.getElementById('switchButton').textContent = t.switchButton;
            document.getElementById('tableButton').textContent = t.tableButton;
            document.getElementById('postureStatusLabel').innerHTML = `${t.postureStatusLabel}<span id="postureStatus">${t.waiting}</span>`;
            document.getElementById('feedbackLabel').textContent = t.feedbackLabel;
            document.getElementById('modalTitle').textContent = t.modalTitle;
        }

        function getSeverityRanges(componentKey) {
            const thresholds = {
                head: { threshold: 0.087, maxDeviation: 0.2, unit: 'degrees', base: 20 },
                neck: { threshold: 0.15, maxDeviation: 0.3, unit: 'degrees', base: 15 },
                shoulders: { threshold: 0.04, maxDeviation: 0.1, unit: 'normalized' },
                arms: { threshold: 0.2, maxDeviation: 0.4, unit: 'normalized' },
                forearms: { threshold: 10, maxDeviation: 20, unit: 'degrees' },
                wrists: { threshold: 10, maxDeviation: 20, unit: 'degrees' },
                hands: { threshold: 15, maxDeviation: 30, unit: 'degrees' },
                back: { threshold: 20, maxDeviation: 40, unit: 'degrees' },
                pelvis: { threshold: 0.1, maxDeviation: 0.2, unit: 'normalized' },
                thighs: { threshold: 10, maxDeviation: 20, unit: 'degrees' },
                knees: { threshold: 10, maxDeviation: 20, unit: 'degrees' },
                feet: { threshold: 0.1, maxDeviation: 0.2, unit: 'normalized' }
            };

            const t = thresholds[componentKey] || { threshold: 0.1, maxDeviation: 0.2, unit: 'normalized' };
            const threshold = t.threshold;
            const isDegrees = t.unit === 'degrees';
            const base = t.base || threshold;

            const ranges = {
                acceptable: isDegrees ? `0° - ${(base * 0.5).toFixed(1)}°` : `0 - ${(threshold * 0.5).toFixed(3)}`,
                faible: isDegrees ? `${(base * 0.5).toFixed(1)}° - ${(base * 1.0).toFixed(1)}°` : `${(threshold * 0.5).toFixed(3)} - ${(threshold * 1.0).toFixed(3)}`,
                eleve: isDegrees ? `${(base * 1.0).toFixed(1)}° - ${(base * 2.0).toFixed(1)}°` : `${(threshold * 1.0).toFixed(3)} - ${(threshold * 2.0).toFixed(3)}`,
                tresEleve: isDegrees ? `> ${(base * 2.0).toFixed(1)}°` : `> ${(threshold * 2.0).toFixed(3)}`
            };

            return ranges;
        }

        function showRiskTables() {
            const modal = document.getElementById('riskModal');
            const riskTables = document.getElementById('riskTables');
            const t = translations[currentLanguage];
            riskTables.innerHTML = '';

            const components = [
                { key: 'head', label: t.components.head },
                { key: 'neck', label: t.components.neck },
                { key: 'shoulders', label: t.components.shoulders },
                { key: 'arms', label: t.components.arms },
                { key: 'forearms', label: t.components.forearms },
                { key: 'wrists', label: t.components.wrists },
                { key: 'hands', label: t.components.hands },
                { key: 'back', label: t.components.back },
                { key: 'pelvis', label: t.components.pelvis },
                { key: 'thighs', label: t.components.thighs },
                { key: 'knees', label: t.components.knees },
                { key: 'feet', label: t.components.feet }
            ];

            components.forEach(({ key, label }) => {
                const ranges = getSeverityRanges(key);
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>${label}</th>
                            <th>Niveau de Gravity</th>
                            <th>Solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${t.details.severity.acceptable}</td>
                            <td>${ranges.acceptable}</td>
                            <td>${t.solutions[key].acceptable}</td>
                        </tr>
                        <tr>
                            <td>${t.details.severity.faible}</td>
                            <td>${ranges.faible}</td>
                            <td>${t.solutions[key].faible}</td>
                        </tr>
                        <tr>
                            <td>${t.details.severity.eleve}</td>
                            <td>${ranges.eleve}</td>
                            <td>${t.solutions[key].eleve}</td>
                        </tr>
                        <tr>
                            <td>${t.details.severity.tresEleve}</td>
                            <td>${ranges.tresEleve}</td>
                            <td>${t.solutions[key].tresEleve}</td>
                        </tr>
                    </tbody>
                `;
                riskTables.appendChild(table);
            });

            modal.style.display = 'block';
        }

        function closeRiskModal() {
            document.getElementById('riskModal').style.display = 'none';
        }

        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const postureStatus = document.getElementById('postureStatus');
        const postureDetails = document.getElementById('postureDetails');
        const postureList = document.getElementById('postureList');
        const analyseView = document.getElementById('analyseView');
        let currentFacingMode = 'environment';

        const postureThresholds = {
            head_inclination: 0.087, // ~20°
            head_rotation: 0.15,
            shoulder_height_diff: 0.04,
            shoulder_arm_height: 0.05,
            arm_extension: 0.2,
            arm_angle_min: 90,
            arm_angle_max: 110,
            forearm_inclination: 10,
            wrist_angle_max: 10,
            back_angle_max: 20,
            pelvis_misalignment: 0.1,
            thigh_angle: 10,
            knee_angle_min: 85,
            knee_angle_max: 95,
            feet_height_diff: 0.1
        };

        function getSeverityLevel(value, threshold, maxDeviation) {
            const deviation = Math.abs(value - threshold);
            if (deviation <= threshold * 0.5) return 'acceptable';
            if (deviation <= threshold * 1.0) return 'faible';
            if (deviation <= threshold * 2.0) return 'eleve';
            return 'tresEleve';
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        pose.onResults(onResults);

        let camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({ image: videoElement });
            },
            width: 640,
            height: 480,
            facingMode: currentFacingMode
        });

        function startAnalysis() {
            camera.start();
            postureStatus.textContent = translations[currentLanguage].analyzing;
            postureDetails.classList.remove('hidden');
            canvasElement.width = analyseView.clientWidth;
            canvasElement.height = canvasElement.width * (480 / 640);
        }

        async function switchCamera() {
            try {
                await camera.stop();
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await pose.send({ image: videoElement });
                    },
                    width: 640,
                    height: 480,
                    facingMode: currentFacingMode
                });
                await camera.start();
                postureStatus.textContent = `${translations[currentLanguage].analyzing} (${currentFacingMode === 'environment' ? translations[currentLanguage].components.back : 'Front'} camera)...`;
            } catch (error) {
                alert('Error switching camera: ' + error.message);
            }
        }

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawLandmarks(results.poseLandmarks);
                const analysis = analyzePosture(results.poseLandmarks);
                displayAnalysis(analysis);
            } else {
                postureStatus.textContent = translations[currentLanguage].noPerson;
                postureList.innerHTML = '';
                postureDetails.classList.add('hidden');
            }
        }

        function drawLandmarks(landmarks) {
            canvasCtx.strokeStyle = '#d4af37';
            canvasCtx.lineWidth = 5;
            for (const landmark of landmarks) {
                canvasCtx.beginPath();
                canvasCtx.arc(landmark.x * canvasElement.width, landmark.y * canvasElement.height, 5, 0, 2 * Math.PI);
                canvasCtx.fillStyle = '#d4af37';
                canvasCtx.fill();
            }
            const connections = [
                [0, 7], [0, 8], [11, 12], [11, 13], [12, 14], [13, 15], [14, 16],
                [11, 23], [12, 24], [23, 24], [23, 25], [24, 26], [25, 27], [26, 28]
            ];
            canvasCtx.strokeStyle = '#c0a062';
            canvasCtx.lineWidth = 10;
            for (const [start, end] of connections) {
                canvasCtx.beginPath();
                canvasCtx.moveTo(landmarks[start].x * canvasElement.width, landmarks[start].y * canvasElement.height);
                canvasCtx.lineTo(landmarks[end].x * canvasElement.width, landmarks[end].y * canvasElement.height);
                canvasCtx.stroke();
            }
        }

        function analyzePosture(landmarks) {
            const analysis = {
                person_detected: true,
                head: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                neck: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                shoulders: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                arms: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                forearms: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                wrists: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                hands: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                back: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable', position: null },
                pelvis: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                thighs: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                knees: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                feet: { status: 'Correcte', details: translations[currentLanguage].details.correct, severity: 'acceptable' },
                global_posture: 'Correcte',
                details: ''
            };

            const nose = landmarks[0];
            const leftEar = landmarks[7];
            const rightEar = landmarks[8];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftElbow = landmarks[13];
            const rightElbow = landmarks[14];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];

            // Head
            const earMidY = (leftEar.y + rightEar.y) / 2;
            const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
            const headInclination = earMidY - shoulderMidY;
            const headRotation = leftEar.x - rightEar.x;
            const headTorsoAlignment = Math.abs(nose.x - (leftHip.x + rightHip.x) / 2);
            let headSeverity = 'acceptable';
            let headDetails = translations[currentLanguage].details.correct;
            if (Math.abs(headInclination) > postureThresholds.head_inclination) {
                headSeverity = getSeverityLevel(Math.abs(headInclination), postureThresholds.head_inclination, 0.2);
                headDetails = `${translations[currentLanguage].details.headForward}${translations[currentLanguage].details.severity[headSeverity]}`;
            }
            if (headTorsoAlignment > 0.1) {
                const severity = getSeverityLevel(headTorsoAlignment, 0.1, 0.2);
                headSeverity = severity > headSeverity ? severity : headSeverity;
                headDetails += headDetails.includes('forward') || headDetails.includes('للأمام') ? ` | ${translations[currentLanguage].details.headMisaligned}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.headMisaligned}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.head.status = headDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.head.details = headDetails;
            analysis.head.severity = headSeverity;

            // Neck
            let neckSeverity = 'acceptable';
            let neckDetails = translations[currentLanguage].details.correct;
            if (Math.abs(headRotation) > postureThresholds.head_rotation) {
                neckSeverity = getSeverityLevel(Math.abs(headRotation), postureThresholds.head_rotation, 0.3);
                neckDetails = `${translations[currentLanguage].details.neckTwisted}${translations[currentLanguage].details.severity[neckSeverity]}`;
            }
            if (Math.abs(headInclination) > postureThresholds.head_inclination * 0.7) {
                const severity = getSeverityLevel(Math.abs(headInclination), postureThresholds.head_inclination * 0.7, 0.15);
                neckSeverity = severity > neckSeverity ? severity : neckSeverity;
                neckDetails += neckDetails.includes('twisted') || neckDetails.includes('ملتوية') ? ` | ${translations[currentLanguage].details.neckTilted}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.neckTilted}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.neck.status = neckDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.neck.details = neckDetails;
            analysis.neck.severity = neckSeverity;

            // Shoulders
            const shoulderHeightDiff = Math.abs(leftShoulder.y - rightShoulder.y);
            const shoulderAbove = Math.min(leftElbow.y, rightElbow.y) < Math.min(leftShoulder.y, rightShoulder.y) - postureThresholds.shoulder_arm_height;
            let shouldersSeverity = 'acceptable';
            let shouldersDetails = translations[currentLanguage].details.correct;
            if (shoulderHeightDiff > postureThresholds.shoulder_height_diff) {
                shouldersSeverity = getSeverityLevel(shoulderHeightDiff, postureThresholds.shoulder_height_diff, 0.1);
                shouldersDetails = `${translations[currentLanguage].details.shouldersRaised}${translations[currentLanguage].details.severity[shouldersSeverity]}`;
            }
            if (shoulderAbove) {
                const severity = getSeverityLevel(Math.min(leftElbow.y, rightElbow.y) - Math.min(leftShoulder.y, rightShoulder.y), postureThresholds.shoulder_arm_height, 0.1);
                shouldersSeverity = severity > shouldersSeverity ? severity : shouldersSeverity;
                shouldersDetails += shouldersDetails.includes('raised') || shouldersDetails.includes('مرفوعة') ? ` | ${translations[currentLanguage].details.shouldersAbove}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.shouldersAbove}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.shoulders.status = shouldersDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.shoulders.details = shouldersDetails;
            analysis.shoulders.severity = shouldersSeverity;

            // Arms
            const armExtensionLeft = Math.abs(leftElbow.x - leftShoulder.x);
            const armExtensionRight = Math.abs(rightElbow.x - rightShoulder.x);
            const armAngleLeft = calculateAngle(leftShoulder, leftElbow, leftWrist);
            const armAngleRight = calculateAngle(rightShoulder, rightElbow, rightWrist);
            let armsSeverity = 'acceptable';
            let armsDetails = translations[currentLanguage].details.correct;
            if (armExtensionLeft > postureThresholds.arm_extension || armExtensionRight > postureThresholds.arm_extension) {
                armsSeverity = getSeverityLevel(Math.max(armExtensionLeft, armExtensionRight), postureThresholds.arm_extension, 0.4);
                armsDetails = `${translations[currentLanguage].details.armsExtended}${translations[currentLanguage].details.severity[armsSeverity]}`;
            }
            if (armAngleLeft < postureThresholds.arm_angle_min || armAngleLeft > postureThresholds.arm_angle_max ||
                armAngleRight < postureThresholds.arm_angle_min || armAngleRight > postureThresholds.arm_angle_max) {
                const severity = getSeverityLevel(Math.min(armAngleLeft, armAngleRight) < postureThresholds.arm_angle_min ? postureThresholds.arm_angle_min - armAngleLeft : armAngleLeft - postureThresholds.arm_angle_max, 10, 20);
                armsSeverity = severity > armsSeverity ? severity : armsSeverity;
                armsDetails += armsDetails.includes('extended') || armsDetails.includes('ممتدان') ? ` | ${translations[currentLanguage].details.armAngleIncorrect}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.armAngleIncorrect}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.arms.status = armsDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.arms.details = armsDetails;
            analysis.arms.severity = armsSeverity;

            // Forearms
            const forearmAngleLeft = calculateVerticalAngle(leftElbow, leftWrist);
            const forearmAngleRight = calculateVerticalAngle(rightElbow, rightWrist);
            let forearmsSeverity = 'acceptable';
            let forearmsDetails = translations[currentLanguage].details.correct;
            if (Math.abs(forearmAngleLeft) > postureThresholds.forearm_inclination || Math.abs(forearmAngleRight) > postureThresholds.forearm_inclination) {
                forearmsSeverity = getSeverityLevel(Math.max(Math.abs(forearmAngleLeft), Math.abs(forearmAngleRight)), postureThresholds.forearm_inclination, 20);
                forearmsDetails = `${translations[currentLanguage].details.forearmsNotHorizontal}${translations[currentLanguage].details.severity[forearmsSeverity]}`;
            }
            if (Math.min(leftElbow.y, rightElbow.y) < Math.min(leftHip.y, rightHip.y) - 0.2) {
                const severity = getSeverityLevel(Math.min(leftElbow.y, rightElbow.y) - Math.min(leftHip.y, rightHip.y), 0.2, 0.4);
                forearmsSeverity = severity > forearmsSeverity ? severity : forearmsSeverity;
                forearmsDetails += forearmsDetails.includes('horizontal') || forearmsDetails.includes('أفقيين') ? ` | ${translations[currentLanguage].details.forearmsSuspended}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.forearmsSuspended}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.forearms.status = forearmsDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.forearms.details = forearmsDetails;
            analysis.forearms.severity = forearmsSeverity;

            // Wrists
            const wristAngleLeft = calculateWristAngle(leftElbow, leftWrist);
            const wristAngleRight = calculateWristAngle(rightElbow, rightWrist);
            let wristsSeverity = 'acceptable';
            let wristsDetails = translations[currentLanguage].details.correct;
            if (Math.abs(wristAngleLeft) > postureThresholds.wrist_angle_max || Math.abs(wristAngleRight) > postureThresholds.wrist_angle_max) {
                wristsSeverity = getSeverityLevel(Math.max(Math.abs(wristAngleLeft), Math.abs(wristAngleRight)), postureThresholds.wrist_angle_max, 20);
                wristsDetails = `${translations[currentLanguage].details.wristNotNeutral}${translations[currentLanguage].details.severity[wristSeverity]}`;
            }
            analysis.wrists.status = wristsDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.wrists.details = wristsDetails;
            analysis.wrists.severity = wristsSeverity;

            // Hands
            let handsSeverity = 'acceptable';
            let handsDetails = translations[currentLanguage].details.correct;
            if (Math.abs(wristAngleLeft) > postureThresholds.wrist_angle_max * 1.5 || Math.abs(wristAngleRight) > postureThresholds.wrist_angle_max * 1.5) {
                handsSeverity = getSeverityLevel(Math.max(Math.abs(wristAngleLeft), Math.abs(wristAngleRight)), postureThresholds.wrist_angle_max * 1.5, 30);
                handsDetails = `${translations[currentLanguage].details.handsTense}${translations[currentLanguage].details.severity[handsSeverity]}`;
            }
            analysis.hands.status = handsDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.hands.details = handsDetails;
            analysis.hands.severity = handsSeverity;

            // Back
            const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
            const hipMidX = (leftHip.x + rightHip.x) / 2;
            const hipMidY = (leftHip.y + rightHip.y) / 2;
            const backAngle = (180 / Math.PI) * Math.atan2(hipMidY - shoulderMidY, hipMidX - shoulderMidX);
            analysis.back.position = { shoulder_mid: [shoulderMidX, shoulderMidY], hip_mid: [hipMidX, hipMidY], angle: backAngle };
            let backSeverity = 'acceptable';
            let backDetails = translations[currentLanguage].details.correct;
            if (Math.abs(backAngle) > postureThresholds.back_angle_max) {
                backSeverity = getSeverityLevel(Math.abs(backAngle), postureThresholds.back_angle_max, 40);
                backDetails = `${translations[currentLanguage].details.backForward}${translations[currentLanguage].details.severity[backSeverity]}`;
            }
            if (Math.abs(shoulderMidX - hipMidX) > 0.1) {
                const severity = getSeverityLevel(Math.abs(shoulderMidX - hipMidX), postureThresholds.pelvis_misalignment, 0.2);
                backSeverity = severity > backSeverity ? severity : backSeverity;
                backDetails += backDetails.includes('forward') || backDetails.includes('للأمام') ? ` | ${translations[currentLanguage].details.backTwisted}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.backTwisted}${translations[currentLanguage].details.severity[severity]}}`;
            }
            analysis.back.status = backDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.back.details = backDetails;
            analysis.back.severity = backSeverity;

            // Pelvis
            const pelvisAlignment = Math.abs(leftHip.x - rightHip.x);
            let pelvisSeverity = 'acceptable';
            let pelvisDetails = translations[currentLanguage].details.correct;
            if (pelvisAlignment > postureThresholds.pelvis_misalignment) {
                pelvisSeverity = getSeverityLevel(pelvisAlignment, postureThresholds.pelvis_misalignment, 0.2);
                pelvisDetails = `${translations[currentLanguage].details.pelvisMisaligned}${translations[currentLanguage].details.severity[pelvisSeverity]}`;
            }
            analysis.pelvis.status = pelvisDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.pelvis.details = pelvisDetails;
            analysis.pelvis.severity = pelvisSeverity;

            // Thighs
            const thighAngleLeft = calculateVerticalAngle(leftHip, leftKnee);
            const thighAngleRight = calculateVerticalAngle(rightHip, rightKnee);
            let thighsSeverity = 'acceptable';
            let thighsDetails = translations[currentLanguage].details.correct;
            if (Math.abs(thighAngleLeft) > postureThresholds.thigh_angle || Math.abs(thighAngleRight) > postureThresholds.thigh_angle) {
                thighsSeverity = getSeverityLevel(Math.max(Math.abs(thighAngleLeft), Math.abs(thighAngleRight)), postureThresholds.thigh_angle, 20);
                thighsDetails = `${translations[currentLanguage].details.thighsNotHorizontal}${translations[currentLanguage].details.severity[thighsSeverity]}`;
            }
            analysis.thighs.status = thighsDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.thighs.details = thighsDetails;
            analysis.thighs.severity = thighsSeverity;

            // Knees
            const kneeAngleLeft = calculateAngle(leftHip, leftKnee, leftAnkle);
            const kneeAngleRight = calculateAngle(rightHip, rightKnee, rightAnkle);
            let kneesSeverity = 'acceptable';
            let kneesDetails = translations[currentLanguage].details.correct;
            if (kneeAngleLeft < postureThresholds.knee_angle_min || keneeAngleLeft > postureThresholds.knee_angle_max || keneeAngleRight < postureThresholds.knee_angle_min || keneeAngleRight > postureThresholds.knee_angle_max) {
                kneesSeverity = getSeverityLevel(Math.min(kneeAngleLeft, kneeAngleRight) < postureThresholds.knee_angle_min ? postureThresholds.knee_angle_min - kneeAngleLeft : kneeAngleLeft - postureThresholds.knee_angle_max, 10, 20);
                kneesDetails = `${translations[currentLanguage].details.kneesNot90}${translations[currentLanguage].details.severity[kneesSeverity]}`;
            }
            analysis.knees.status = kneesDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.knees.details = kneesDetails;
            analysis.knees.severity = kneesSeverity;

            // Feet
            let feetSeverity = 'acceptable';
            let feetDetails = translations[currentLanguage].details.correct;
            if (Math.abs(leftAnkle.y - rightAnkle.y) > postureThresholds.feet_height_diff) {
                feetSeverity = getSeverityLevel(Math.abs(leftAnkle.y - rightAnkle.y), postureThresholds.feet_height_diff, 0.2);
                feetDetails = `${translations[currentLanguage].details.feetCrossed}${translations[currentLanguage].details.severity[feetSeverity]}`;
            }
            if (Math.max(leftAnkle.y, rightAnkle.y) < Math.min(leftHip.y, rightHip.y) - 0.3) {
                const severity = getSeverityLevel(Math.max(leftAnkle.y, rightAnkle.y) - Math.min(leftHip.y, rightHip.y), 0.3, 0.5);
                feetSeverity = severity > feetSeverity ? severity : feetSeverity;
                feetDetails += feetDetails.includes('crossed') || feetDetails.includes('متقاطعتان') ? ` | ${translations[currentLanguage].details.feetNotFlat}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.feetNotFlat}${translations[currentLanguage].details.severity[severity]}`;
            }
            analysis.feet.status = feetDetails === translations[currentLanguage].details.correct ? 'Correcte' : 'Incorrecte';
            analysis.feet.details = feetDetails;
            analysis.feet.severity = feetSeverity;

            // Global Posture
            const components = ['head', 'neck', 'shoulders', 'arms', 'forearms', 'wrists', 'hands', 'back', 'pelvis', 'thighs', 'knees', 'feet'];
            for (const comp of components) {
                if (analysis[comp].status === 'Incorrecte') {
                    analysis.global_posture = 'Incorrecte';
                    break;
                }
            }

            return analysis;
        }

        function calculateAngle(a, b, c) {
            const ba = [a.x - b.x, a.y - b.y];
            const bc = [c.x - b.x, c.y - b.y];
            const cosineAngle = (ba[0] * bc[0] + ba[1] * ba[1]) / (Math.sqrt(ba[0]**2 + ba[1]**2) * Math.sqrt(bc[0]**2 + bc[1]**2));
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function calculateVerticalAngle(a, b) {
            const vertical = [0, -1];
            const ab = [b.x - a.x, b.y - a.y];
            const cosineAngle = (vertical[0] * ab[0] + vertical[1] * ab[1]) / Math.sqrt(ab[0]**2 + ab[1]**2);
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function calculateWristAngle(elbow, wrist) {
            const forearmVector = [wrist.x - elbow.x, wrist.y - elbow.y];
            const vertical = [0, 1];
            const cosineAngle = (forearmVector[0] * vertical[0] + forearmVector[1] * vertical[1]) / Math.sqrt(forearmVector[0]**2 + forearmVector[1]**2);
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function displayAnalysis(analysis) {
            postureStatus.textContent = analysis.global_posture;
            postureStatus.className = analysis.global_posture === 'Correcte' ? 'status-correct' : 'status-incorrect';

            postureList.innerHTML = '';
            const components = [
                { key: 'head', label: translations[currentLanguage].components.head },
                { key: 'neck', label: translations[currentLanguage].components.neck },
                { key: 'shoulders', label: translations[currentLanguage].components.shoulders },
                { key: 'arms', label: translations[currentLanguage].components.arms },
                { key: 'forearms', label: translations[currentLanguage].components.forearms },
                { key: 'wrists', label: translations[currentLanguage].components.wrists },
                { key: 'hands', label: translations[currentLanguage].components.hands },
                { key: 'back', label: translations[currentLanguage].components.back },
                { key: 'pelvis', label: translations[currentLanguage].components.pelvis },
                { key: 'thighs', label: translations[currentLanguage].components.thighs },
                { key: 'knees', label: translations[currentLanguage].components.knees },
                { key: 'feet', label: translations[currentLanguage].components.feet }
            ];

            for (const { key, label } of components) {
                const li = document.createElement('li');
                const severityText = translations[currentLanguage].details.severity[analysis[key].severity];
                li.innerHTML = `${label}: ${analysis[key].details} <span class="severity-${analysis[key].severity}">[${severityText}]</span>`;
                li.className = analysis[key].status === 'Correcte' ? 'status-correct' : 'status-incorrect';
                postureList.appendChild(li);
            }

            postureDetails.classList.remove('hidden');

            if (analysis.back.position) {
                const shoulderMid = analysis.back.position.shoulder_mid;
                const hipMid = analysis.back.position.hip_mid;
                canvasCtx.beginPath();
                canvasCtx.moveTo(shoulderMid[0] * canvasElement.width, shoulderMid[1] * canvasElement.height);
                canvasCtx.lineTo(hipMid[0] * canvasElement.width, hipMid[1] * canvasElement.height);
                canvasCtx.strokeStyle = analysis.back.status === 'Correcte' ? '#4ade80' : '#ff4d4d';
                canvasCtx.lineWidth = 10;
                canvasCtx.stroke();

                const backAngle = analysis.back.position.angle;
                const midPoint = [
                    (shoulderMid[0] * canvasElement.width + hipMid[0] * canvasElement.width) / 2 + 50,
                    (shoulderMid[1] * canvasElement.height + hipMid[1] * canvasElement.height) / 2
                ];
                canvasCtx.fillStyle = '#d4af37';
                canvasCtx.font = '18px Inter';
                canvasCtx.fillText(`Back Angle: ${Math.round(backAngle)}°`, midPoint[0], midPoint[1]);
            }
        }
    </script>
</body>
</html>