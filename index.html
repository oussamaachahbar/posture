<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postural Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            color: #ffd700;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
            text-align: center;
        }
        video {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #d4af37;
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            object-fit: cover;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        video:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.6);
        }
        canvas {
            border: 4px solid #a0aec0;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 1280px;
            height: auto;
            background: #2d3748;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .premium-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 15px;
            padding: 2rem;
            border-left: 6px solid #d4af37;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(212, 175, 55, 0.5);
        }
        .status-incorrect {
            color: #ff6347;
            font-weight: 700;
            animation: pulse 1.5s infinite;
        }
        .status-correct {
            color: #4ade80;
            font-weight: 700;
        }
        button {
            background: linear-gradient(90deg, #d4af37 0%, #f1c40f 100%);
            color: #1a202c;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(90deg, #f1c40f 0%, #d4af37 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.6);
        }
        select {
            background: #2d3748;
            color: #e2e8f0;
            border: 2px solid #d4af37;
            border-radius: 12px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        select:hover {
            background: #4a5568;
        }
        .personal-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .personal-info img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #d4af37;
            object-fit: cover;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            canvas {
                max-width: 100%;
            }
            video {
                width: 100px;
                height: 100px;
                top: 10px;
                right: 10px;
            }
            h1 {
                font-size: 2.25rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <h1 class="text-center mb-8" id="title">Postural Analysis System</h1>
    <div class="container flex flex-col md:flex-row gap-8 w-full">
        <div class="flex-1">
            <div class="personal-info premium-card">
                <img src="https://via.placeholder.com/80" alt="User's Photo">
                <button id="personalButton">Kamal</button>
                <select id="languageSelect" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="ar">العربية</option>
                </select>
            </div>
        </div>
        <div id="analyseView" class="flex-1 relative">
            <video id="video" autoplay class="mb-4"></video>
            <canvas id="canvas" class="mb-4"></canvas>
            <div class="flex gap-4 flex-wrap justify-center">
                <button id="startButton" onclick="startAnalysis()">Start Analysis</button>
                <button id="switchButton" onclick="switchCamera()">Switch Camera</button>
            </div>
            <div id="analysis" class="p-6 mt-6 premium-card">
                <p class="text-lg" id="postureStatusLabel">Postural Status: <span id="postureStatus">Waiting for analysis...</span></p>
                <div id="postureDetails" class="mt-4 hidden">
                    <p class="text-lg font-semibold text-yellow-400" id="feedbackLabel">Posture Feedback:</p>
                    <ul id="postureList" class="list-disc list-inside mt-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                title: "Postural Analysis System",
                startButton: "Start Analysis",
                switchButton: "Switch Camera",
                postureStatusLabel: "Postural Status: ",
                feedbackLabel: "Posture Feedback:",
                waiting: "Waiting for analysis...",
                analyzing: "Analyzing posture...",
                noPerson: "No person detected",
                components: {
                    head: "Head",
                    neck: "Neck",
                    shoulders: "Shoulders",
                    back: "Back",
                    elbows: "Elbows",
                    wrists: "Wrists",
                    hands: "Hands",
                    thighs: "Thighs",
                    knees: "Knees",
                    feet: "Feet",
                    hips: "Hips"
                },
                details: {
                    headForward: "Head tilted forward",
                    headBackward: "Head tilted backward",
                    headRotated: "Head rotated",
                    neckTilted: "Neck tilted",
                    neckTwisted: "Neck twisted",
                    shouldersAsymmetric: "Asymmetric shoulders",
                    shouldersRaised: "Shoulders raised",
                    shouldersAbove: "Arms above shoulder line",
                    backForward: "Back too bent forward",
                    backBackward: "Back too bent backward",
                    elbowLeft: "Left elbow mispositioned",
                    elbowRight: "Right elbow mispositioned",
                    armsExtended: "Arms excessively extended",
                    wristLeft: "Left wrist bent",
                    wristRight: "Right wrist bent",
                    handsTense: "Hands tense or cramped",
                    thighLeft: "Left thigh mispositioned",
                    thighRight: "Right thigh mispositioned",
                    kneeLeft: "Left knee mispositioned",
                    kneeRight: "Right knee mispositioned",
                    hipsMisaligned: "Hips misaligned with trunk",
                    feetCrossed: "Legs crossed or suspended",
                    feetNotFlat: "Feet not flat on the ground",
                    correct: "Correct position"
                }
            },
            fr: {
                title: "Système d'Analyse Posturale",
                startButton: "Démarrer l'Analyse",
                switchButton: "Changer de Caméra",
                postureStatusLabel: "État de la Posture : ",
                feedbackLabel: "Retour sur la Posture :",
                waiting: "En attente d'analyse...",
                analyzing: "Analyse de la posture...",
                noPerson: "Aucune personne détectée",
                components: {
                    head: "Tête",
                    neck: "Cou",
                    shoulders: "Épaules",
                    back: "Dos",
                    elbows: "Coudes",
                    wrists: "Poignets",
                    hands: "Mains",
                    thighs: "Cuisses",
                    knees: "Genoux",
                    feet: "Pieds",
                    hips: "Hanches"
                },
                details: {
                    headForward: "Tête penchée vers l'avant",
                    headBackward: "Tête penchée vers l'arrière",
                    headRotated: "Tête tournée",
                    neckTilted: "Cou incliné",
                    neckTwisted: "Cou tordu",
                    shouldersAsymmetric: "Épaules asymétriques",
                    shouldersRaised: "Épaules relevées",
                    shouldersAbove: "Bras au-dessus de la ligne des épaules",
                    backForward: "Dos trop penché en avant",
                    backBackward: "Dos trop penché en arrière",
                    elbowLeft: "Coude gauche mal positionné",
                    elbowRight: "Coude droit mal positionné",
                    armsExtended: "Bras trop étendus vers l'avant",
                    wristLeft: "Poignet gauche cassé",
                    wristRight: "Poignet droit cassé",
                    handsTense: "Mains tendues ou crispées",
                    thighLeft: "Cuisse gauche mal positionnée",
                    thighRight: "Cuisse droite mal positionnée",
                    kneeLeft: "Genou gauche mal positionné",
                    kneeRight: "Genou droit mal positionné",
                    hipsMisaligned: "Hanches mal alignées avec le tronc",
                    feetCrossed: "Jambes croisées ou suspendues",
                    feetNotFlat: "Pieds non à plat sur le sol",
                    correct: "Position correcte"
                }
            },
            ar: {
                title: "نظام تحليل الوضعية",
                startButton: "بدء التحليل",
                switchButton: "تبديل الكاميرا",
                postureStatusLabel: "حالة الوضعية: ",
                feedbackLabel: "تعليقات الوضعية:",
                waiting: "في انتظار التحليل...",
                analyzing: "جارٍ تحليل الوضعية...",
                noPerson: "لم يتم اكتشاف أي شخص",
                components: {
                    head: "الرأس",
                    neck: "الرقبة",
                    shoulders: "الأكتاف",
                    back: "الظهر",
                    elbows: "الأكواع",
                    wrists: "المعصمان",
                    hands: "اليدان",
                    thighs: "الفخذان",
                    knees: "الركبتان",
                    feet: "القدمان",
                    hips: "الوركان"
                },
                details: {
                    headForward: "الرأس مائل للأمام",
                    headBackward: "الرأس مائل للخلف",
                    headRotated: "الرأس متجه جانبيًا",
                    neckTilted: "الرقبة مائلة",
                    neckTwisted: "الرقبة ملتوية",
                    shouldersAsymmetric: "الأكتاف غير متماثلة",
                    shouldersRaised: "الأكتاف مرتفعة",
                    shouldersAbove: "الأذرع فوق خط الأكتاف",
                    backForward: "الظهر مائل للأمام كثيرًا",
                    backBackward: "الظهر مائل للخلف كثيرًا",
                    elbowLeft: "الكوع الأيسر في وضع غير صحيح",
                    elbowRight: "الكوع الأيمن في وضع غير صحيح",
                    armsExtended: "الأذرع ممتدة بشكل مفرط للأمام",
                    wristLeft: "المعصم الأيسر مثني",
                    wristRight: "المعصم الأيمن مثني",
                    handsTense: "اليدان مشدودتان أو متشنجتان",
                    thighLeft: "الفخذ الأيسر في وضع غير صحيح",
                    thighRight: "الفخذ الأيمن في وضع غير صحيح",
                    kneeLeft: "الركبة اليسرى في وضع غير صحيح",
                    kneeRight: "الركبة اليمنى في وضع غير صحيح",
                    hipsMisaligned: "الوركان غير محاذيان مع الجذع",
                    feetCrossed: "الساقان متقاطعتان أو معلقتان",
                    feetNotFlat: "القدمان ليستا مسطحتين على الأرض",
                    correct: "الوضعية صحيحة"
                }
            }
        };

        let currentLanguage = 'en';

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            const t = translations[currentLanguage];
            document.getElementById('title').textContent = t.title;
            document.getElementById('startButton').textContent = t.startButton;
            document.getElementById('switchButton').textContent = t.switchButton;
            document.getElementById('postureStatusLabel').innerHTML = `${t.postureStatusLabel}<span id="postureStatus">${t.waiting}</span>`;
            document.getElementById('feedbackLabel').textContent = t.feedbackLabel;
        }

        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const postureStatus = document.getElementById('postureStatus');
        const postureDetails = document.getElementById('postureDetails');
        const postureList = document.getElementById('postureList');
        const analyseView = document.getElementById('analyseView');
        let currentFacingMode = 'environment';

        const postureThresholds = {
            head_inclination: 0.08, // ~20°
            head_rotation: 0.15,
            shoulder_height_diff: 0.04,
            shoulder_elevation: 0.05,
            arm_extension: 0.2,
            elbow_angle_min: 90,
            elbow_angle_max: 110,
            wrist_angle_max: 15,
            back_angle_max: 20,
            thigh_angle_min: 85,
            thigh_angle_max: 95,
            knee_angle_min: 85,
            knee_angle_max: 95,
            hip_alignment: 0.1,
            feet_height_diff: 0.1
        };

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        pose.onResults(onResults);

        let camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({ image: videoElement });
            },
            width: 640,
            height: 480,
            facingMode: currentFacingMode
        });

        function startAnalysis() {
            camera.start();
            postureStatus.textContent = translations[currentLanguage?
