<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Postural Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            overflow-x: hidden;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6);
            text-align: center;
            margin-bottom: 2rem;
        }
        video {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid #d4af37;
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.4);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            object-fit: cover;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        video:hover {
            transform: scale(1.15);
            box-shadow: 0 12px 30px rgba(212, 175, 55, 0.6);
        }
        canvas {
            border: 4px solid #a0aec0;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 960px;
            height: auto;
            background: #2d3748;
            margin: 0 auto;
            display: block;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .premium-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 15px;
            padding: 2rem;
            border-left: 6px solid #d4af37;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(212, 175, 55, 0.5);
        }
        .status-incorrect {
            color: #ff4d4d;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        .status-correct {
            color: #4ade80;
            font-weight: 600;
        }
        button {
            background: linear-gradient(90deg, #d4af37 0%, #c0a062 100%);
            color: #1a202c;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(90deg, #c0a062 0%, #d4af37 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.5);
        }
        select {
            background: #2d3748;
            color: #e2e8f0;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        select:hover {
            background: #4a5568;
        }
        .personal-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .personal-info img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #d4af37;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            canvas {
                max-width: 100%;
            }
            video {
                width: 120px;
                height: 120px;
                top: 10px;
                right: 10px;
            }
            h1 {
                font-size: 2.25rem;
            }
            .personal-info {
                flex-direction: column;
                align-items: center;
            }
            .personal-info img {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <h1 id="title">Advanced Postural Analysis System</h1>
    <div class="container">
        <div class="personal-info premium-card">
            <img src="https://via.placeholder.com/120" alt="User's Photo">
            <button id="personalButton">User Profile</button>
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="ar">العربية</option>
            </select>
        </div>
        <div id="analyseView" class="relative">
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
            <div class="flex gap-4 flex-wrap justify-center mt-6">
                <button id="startButton" onclick="startAnalysis()">Start Analysis</button>
                <button id="switchButton" onclick="switchCamera()">Switch Camera</button>
            </div>
            <div id="analysis" class="premium-card mt-6">
                <p class="text-lg font-semibold" id="postureStatusLabel">Postural Status: <span id="postureStatus">Waiting for analysis...</span></p>
                <div id="postureDetails" class="hidden mt-4">
                    <p class="text-lg font-semibold text-yellow-400" id="feedbackLabel">Posture Feedback:</p>
                    <ul id="postureList" class="list-disc list-inside mt-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                title: "Advanced Postural Analysis System",
                startButton: "Start Analysis",
                switchButton: "Switch Camera",
                postureStatusLabel: "Postural Status: ",
                feedbackLabel: "Posture Feedback:",
                waiting: "Waiting for analysis...",
                analyzing: "Analyzing posture...",
                noPerson: "No person detected",
                components: {
                    head: "Head",
                    neck: "Neck",
                    shoulders: "Shoulders",
                    arms: "Arms",
                    forearms: "Forearms",
                    wrists: "Wrists",
                    hands: "Hands",
                    back: "Back",
                    pelvis: "Pelvis",
                    thighs: "Thighs",
                    knees: "Knees",
                    feet: "Feet"
                },
                details: {
                    headForward: "Head tilted forward beyond 20°",
                    headMisaligned: "Head not aligned with torso",
                    neckTilted: "Neck tilted or flexed excessively",
                    neckTwisted: "Neck twisted",
                    shouldersRaised: "Shoulders raised or tense",
                    shouldersAbove: "Arms above shoulder line",
                    armsExtended: "Arms excessively extended forward",
                    armAngleIncorrect: "Arm-forearm angle not between 90-110°",
                    forearmsNotHorizontal: "Forearms not horizontal or slightly inclined",
                    forearmsSuspended: "Forearms suspended without support",
                    wristsNotNeutral: "Wrists not aligned with forearms",
                    wristsFlexed: "Wrists flexed excessively",
                    handsTense: "Hands tense or fingers cramped",
                    backForward: "Back tilted forward beyond 20°",
                    backTwisted: "Back twisted",
                    pelvisMisaligned: "Pelvis not aligned with torso",
                    thighsNotHorizontal: "Thighs not horizontal when seated",
                    thighsLocked: "Thighs locked when standing",
                    kneesNot90: "Knees not at 90° when seated",
                    kneesLocked: "Knees locked when standing",
                    feetNotFlat: "Feet not flat on the ground",
                    feetCrossed: "Feet crossed or on tiptoes",
                    correct: "Correct position",
                    severity: {
                        acceptable: " (Acceptable)",
                        faible: " (Low)",
                        eleve: " (High)",
                        tresEleve: " (Very High)"
                    }
                }
            },
            fr: {
                title: "Système Avancé d'Analyse Posturale",
                startButton: "Démarrer l'Analyse",
                switchButton: "Changer de Caméra",
                postureStatusLabel: "État de la Posture : ",
                feedbackLabel: "Retour sur la Posture :",
                waiting: "En attente d'analyse...",
                analyzing: "Analyse de la posture...",
                noPerson: "Aucune personne détectée",
                components: {
                    head: "Tête",
                    neck: "Cou",
                    shoulders: "Épaules",
                    arms: "Bras",
                    forearms: "Avant-bras",
                    wrists: "Poignets",
                    hands: "Mains",
                    back: "Dos",
                    pelvis: "Bassin",
                    thighs: "Cuisses",
                    knees: "Genoux",
                    feet: "Pieds"
                },
                details: {
                    headForward: "Tête penchée vers l'avant au-delà de 20°",
                    headMisaligned: "Tête non alignée avec le tronc",
                    neckTilted: "Cou incliné ou fléchi excessivement",
                    neckTwisted: "Cou tordu",
                    shouldersRaised: "Épaules relevées ou tendues",
                    shouldersAbove: "Bras au-dessus de la ligne des épaules",
                    armsExtended: "Bras trop étendus vers l'avant",
                    armAngleIncorrect: "Angle bras-avant-bras non compris entre 90-110°",
                    forearmsNotHorizontal: "Avant-bras non horizontaux ou légèrement inclinés",
                    forearmsSuspended: "Avant-bras suspendus sans support",
                    wristsNotNeutral: "Poignets non alignés avec les avant-bras",
                    wristsFlexed: "Poignets fléchis excessivement",
                    handsTense: "Mains tendues ou doigts crispés",
                    backForward: "Dos incliné vers l'avant au-delà de 20°",
                    backTwisted: "Dos tordu",
                    pelvisMisaligned: "Bassin non aligné avec le tronc",
                    thighsNotHorizontal: "Cuisses non horizontales en position assise",
                    thighsLocked: "Cuisses verrouillées en position debout",
                    kneesNot90: "Genoux non à 90° en position assise",
                    kneesLocked: "Genoux verrouillés en position debout",
                    feetNotFlat: "Pieds non à plat sur le sol",
                    feetCrossed: "Pieds croisés ou sur la pointe",
                    correct: "Position correcte",
                    severity: {
                        acceptable: " (Acceptable)",
                        faible: " (Faible)",
                        eleve: " (Élevé)",
                        tresEleve: " (Très Élevé)"
                    }
                }
            },
            ar: {
                title: "نظام تحليل الوضعية المتقدم",
                startButton: "بدء التحليل",
                switchButton: "تبديل الكاميرا",
                postureStatusLabel: "حالة الوضعية: ",
                feedbackLabel: "تعليقات الوضعية:",
                waiting: "في انتظار التحليل...",
                analyzing: "جارٍ تحليل الوضعية...",
                noPerson: "لم يتم اكتشاف أي شخص",
                components: {
                    head: "الرأس",
                    neck: "الرقبة",
                    shoulders: "الأكتاف",
                    arms: "الذراعان",
                    forearms: "الساعدان",
                    wrists: "المعصمان",
                    hands: "اليدان",
                    back: "الظهر",
                    pelvis: "الحوض",
                    thighs: "الفخذان",
                    knees: "الركبتان",
                    feet: "القدمان"
                },
                details: {
                    headForward: "الرأس مائل للأمام أكثر من 20 درجة",
                    headMisaligned: "الرأس غير محاذٍ للجذع",
                    neckTilted: "الرقبة مائلة أو مثنية بشكل مفرط",
                    neckTwisted: "الرقبة ملتوية",
                    shouldersRaised: "الأكتاف مرفوعة أو مشدودة",
                    shouldersAbove: "الذراعان فوق خط الأكتاف",
                    armsExtended: "الذراعان ممتدان للأمام بشكل مفرط",
                    armAngleIncorrect: "زاوية الذراع-الساعد ليست بين 90-110 درجات",
                    forearmsNotHorizontal: "الساعدان غير أفقيين أو مائلين قليلاً",
                    forearmsSuspended: "الساعدان معلقان بدون دعم",
                    wristsNotNeutral: "المعصمان غير محاذيين للساعدين",
                    wristsFlexed: "المعصمان مثنيان بشكل مفرط",
                    handsTense: "اليدان مشدودتان أو الأصابع متشنجة",
                    backForward: "الظهر مائل للأمام أكثر من 20 درجة",
                    backTwisted: "الظهر ملتوي",
                    pelvisMisaligned: "الحوض غير محاذٍ للجذع",
                    thighsNotHorizontal: "الفخذان غير أفقيين عند الجلوس",
                    thighsLocked: "الفخذان مقفلان عند الوقوف",
                    kneesNot90: "الركبتان ليستا بزاوية 90 درجة عند الجلوس",
                    kneesLocked: "الركبتان مقفلتان عند الوقوف",
                    feetNotFlat: "القدمان ليستا مسطحتين على الأرض",
                    feetCrossed: "القدمان متقاطعتان أو على أطراف الأصابع",
                    correct: "الوضعية صحيحة",
                    severity: {
                        acceptable: " (مقبول)",
                        faible: " (ضعيف)",
                        eleve: " (مرتفع)",
                        tresEleve: " (عالٍ جدًا)"
                    }
                }
            }
        };

        let currentLanguage = 'en';

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            const t = translations[currentLanguage];
            document.getElementById('title').textContent = t.title;
            document.getElementById('startButton').textContent = t.startButton;
            document.getElementById('switchButton').textContent = t.switchButton;
            document.getElementById('postureStatusLabel').innerHTML = `${t.postureStatusLabel}<span id="postureStatus">${t.waiting}</span>`;
            document.getElementById('feedbackLabel').textContent = t.feedbackLabel;
        }

        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const postureStatus = document.getElementById('postureStatus');
        const postureDetails = document.getElementById('postureDetails');
        const postureList = document.getElementById('postureList');
        const analyseView = document.getElementById('analyseView');
        let currentFacingMode = 'environment';

        const postureThresholds = {
            head_inclination: 0.087, // ~20°
            head_rotation: 0.15,
            shoulder_height_diff: 0.04,
            shoulder_arm_height: 0.05,
            arm_extension: 0.2,
            arm_angle_min: 90,
            arm_angle_max: 110,
            forearm_inclination: 10,
            wrist_angle_max: 10,
            back_angle_max: 20,
            pelvis_misalignment: 0.1,
            thigh_angle: 10,
            knee_angle_min: 85,
            knee_angle_max: 95,
            feet_height_diff: 0.1
        };

        function getSeverityLevel(value, threshold, maxDeviation) {
            const deviation = Math.abs(value - threshold);
            if (deviation <= threshold * 0.5) return 'acceptable';
            if (deviation <= threshold * 1.0) return 'faible';
            if (deviation <= threshold * 2.0) return 'eleve';
            return 'tresEleve';
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        pose.onResults(onResults);

        let camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({ image: videoElement });
            },
            width: 640,
            height: 480,
            facingMode: currentFacingMode
        });

        function startAnalysis() {
            camera.start();
            postureStatus.textContent = translations[currentLanguage].analyzing;
            postureDetails.classList.remove('hidden');
            canvasElement.width = analyseView.clientWidth;
            canvasElement.height = canvasElement.width * (480 / 640);
        }

        async function switchCamera() {
            try {
                await camera.stop();
                currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await pose.send({ image: videoElement });
                    },
                    width: 640,
                    height: 480,
                    facingMode: currentFacingMode
                });
                await camera.start();
                postureStatus.textContent = `${translations[currentLanguage].analyzing} (${currentFacingMode === 'environment' ? translations[currentLanguage].components.back : 'Front'} camera)...`;
            } catch (error) {
                alert('Error switching camera: ' + error.message);
            }
        }

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawLandmarks(results.poseLandmarks);
                const analysis = analyzePosture(results.poseLandmarks);
                displayAnalysis(analysis);
            } else {
                postureStatus.textContent = translations[currentLanguage].noPerson;
                postureList.innerHTML = '';
                postureDetails.classList.add('hidden');
            }
        }

        function drawLandmarks(landmarks) {
            canvasCtx.strokeStyle = '#d4af37';
            canvasCtx.lineWidth = 5;
            for (const landmark of landmarks) {
                canvasCtx.beginPath();
                canvasCtx.arc(landmark.x * canvasElement.width, landmark.y * canvasElement.height, 5, 0, 2 * Math.PI);
                canvasCtx.fillStyle = '#d4af37';
                canvasCtx.fill();
            }
            const connections = [
                [0, 7], [0, 8], [11, 12], [11, 13], [12, 14], [13, 15], [14, 16],
                [11, 23], [12, 24], [23, 24], [23, 25], [24, 26], [25, 27], [26, 28]
            ];
            canvasCtx.strokeStyle = '#c0a062';
            canvasCtx.lineWidth = 10;
            for (const [start, end] of connections) {
                canvasCtx.beginPath();
                canvasCtx.moveTo(landmarks[start].x * canvasElement.width, landmarks[start].y * canvasElement.height);
                canvasCtx.lineTo(landmarks[end].x * canvasElement.width, landmarks[end].y * canvasElement.height);
                canvasCtx.stroke();
            }
        }

        function analyzePosture(landmarks) {
            const analysis = {
                person_detected: true,
                head: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                neck: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                shoulders: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                arms: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                forearms: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                wrists: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                hands: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                back: { status: 'Correcte', details: translations[currentLanguage].details.correct, position: null },
                pelvis: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                thighs: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                knees: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                feet: { status: 'Correcte', details: translations[currentLanguage].details.correct },
                global_posture: 'Correcte',
                details: ''
            };

            const nose = landmarks[0];
            const leftEar = landmarks[7];
            const rightEar = landmarks[8];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftElbow = landmarks[13];
            const rightElbow = landmarks[14];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];

            // Head and Neck
            const earMidY = (leftEar.y + rightEar.y) / 2;
            const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
            const headInclination = earMidY - shoulderMidY;
            const headRotation = leftEar.x - rightEar.x;
            const headTorsoAlignment = Math.abs(nose.x - (leftHip.x + rightHip.x) / 2);
            if (Math.abs(headInclination) > postureThresholds.head_inclination) {
                const severity = getSeverityLevel(Math.abs(headInclination), postureThresholds.head_inclination, 0.2);
                analysis.head.status = 'Incorrecte';
                analysis.head.details = `${translations[currentLanguage].details.headForward}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (headTorsoAlignment > 0.1) {
                const severity = getSeverityLevel(headTorsoAlignment, 0.1, 0.2);
                analysis.head.status = 'Incorrecte';
                analysis.head.details += analysis.head.details.includes('forward') || analysis.head.details.includes('للأمام') ? ` | ${translations[currentLanguage].details.headMisaligned}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.headMisaligned}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (Math.abs(headRotation) > postureThresholds.head_rotation) {
                const severity = getSeverityLevel(Math.abs(headRotation), postureThresholds.head_rotation, 0.3);
                analysis.neck.status = 'Incorrecte';
                analysis.neck.details = `${translations[currentLanguage].details.neckTwisted}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (Math.abs(headInclination) > postureThresholds.head_inclination * 0.7) {
                const severity = getSeverityLevel(Math.abs(headInclination), postureThresholds.head_inclination * 0.7, 0.15);
                analysis.neck.status = 'Incorrecte';
                analysis.neck.details += analysis.neck.details.includes('twisted') || analysis.neck.details.includes('ملتوية') ? ` | ${translations[currentLanguage].details.neckTilted}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.neckTilted}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Shoulders
            const shoulderHeightDiff = Math.abs(leftShoulder.y - rightShoulder.y);
            const shoulderAbove = Math.min(leftElbow.y, rightElbow.y) < Math.min(leftShoulder.y, rightShoulder.y) - postureThresholds.shoulder_arm_height;
            if (shoulderHeightDiff > postureThresholds.shoulder_height_diff) {
                const severity = getSeverityLevel(shoulderHeightDiff, postureThresholds.shoulder_height_diff, 0.1);
                analysis.shoulders.status = 'Incorrecte';
                analysis.shoulders.details = `${translations[currentLanguage].details.shouldersRaised}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (shoulderAbove) {
                const severity = getSeverityLevel(Math.min(leftElbow.y, rightElbow.y) - Math.min(leftShoulder.y, rightShoulder.y), postureThresholds.shoulder_arm_height, 0.1);
                analysis.shoulders.status = 'Incorrecte';
                analysis.shoulders.details += analysis.shoulders.details.includes('raised') || analysis.shoulders.details.includes('مرفوعة') ? ` | ${translations[currentLanguage].details.shouldersAbove}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.shouldersAbove}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Arms
            const armExtensionLeft = Math.abs(leftElbow.x - leftShoulder.x);
            const armExtensionRight = Math.abs(rightElbow.x - rightShoulder.x);
            const armAngleLeft = calculateAngle(leftShoulder, leftElbow, leftWrist);
            const armAngleRight = calculateAngle(rightShoulder, rightElbow, rightWrist);
            if (armExtensionLeft > postureThresholds.arm_extension || armExtensionRight > postureThresholds.arm_extension) {
                const severity = getSeverityLevel(Math.max(armExtensionLeft, armExtensionRight), postureThresholds.arm_extension, 0.4);
                analysis.arms.status = 'Incorrecte';
                analysis.arms.details = `${translations[currentLanguage].details.armsExtended}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (armAngleLeft < postureThresholds.arm_angle_min || armAngleLeft > postureThresholds.arm_angle_max ||
                armAngleRight < postureThresholds.arm_angle_min || armAngleRight > postureThresholds.arm_angle_max) {
                const severity = getSeverityLevel(Math.min(armAngleLeft, armAngleRight) < postureThresholds.arm_angle_min ? postureThresholds.arm_angle_min - armAngleLeft : armAngleLeft - postureThresholds.arm_angle_max, 10, 20);
                analysis.arms.status = 'Incorrecte';
                analysis.arms.details += analysis.arms.details.includes('extended') || analysis.arms.details.includes('ممتدان') ? ` | ${translations[currentLanguage].details.armAngleIncorrect}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.armAngleIncorrect}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Forearms
            const forearmAngleLeft = calculateVerticalAngle(leftElbow, leftWrist);
            const forearmAngleRight = calculateVerticalAngle(rightElbow, rightWrist);
            if (Math.abs(forearmAngleLeft) > postureThresholds.forearm_inclination || Math.abs(forearmAngleRight) > postureThresholds.forearm_inclination) {
                const severity = getSeverityLevel(Math.max(Math.abs(forearmAngleLeft), Math.abs(forearmAngleRight)), postureThresholds.forearm_inclination, 20);
                analysis.forearms.status = 'Incorrecte';
                analysis.forearms.details = `${translations[currentLanguage].details.forearmsNotHorizontal}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (Math.min(leftElbow.y, rightElbow.y) < Math.min(leftHip.y, rightHip.y) - 0.2) {
                const severity = getSeverityLevel(Math.min(leftElbow.y, rightElbow.y) - Math.min(leftHip.y, rightHip.y), 0.2, 0.4);
                analysis.forearms.status = 'Incorrecte';
                analysis.forearms.details += analysis.forearms.details.includes('horizontal') || analysis.forearms.details.includes('أفقيين') ? ` | ${translations[currentLanguage].details.forearmsSuspended}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.forearmsSuspended}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Wrists
            const wristAngleLeft = calculateWristAngle(leftElbow, leftWrist);
            const wristAngleRight = calculateWristAngle(rightElbow, rightWrist);
            if (Math.abs(wristAngleLeft) > postureThresholds.wrist_angle_max || Math.abs(wristAngleRight) > postureThresholds.wrist_angle_max) {
                const severity = getSeverityLevel(Math.max(Math.abs(wristAngleLeft), Math.abs(wristAngleRight)), postureThresholds.wrist_angle_max, 20);
                analysis.wrists.status = 'Incorrecte';
                analysis.wrists.details = `${translations[currentLanguage].details.wristsNotNeutral}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Hands
            if (Math.abs(wristAngleLeft) > postureThresholds.wrist_angle_max * 1.5 || Math.abs(wristAngleRight) > postureThresholds.wrist_angle_max * 1.5) {
                const severity = getSeverityLevel(Math.max(Math.abs(wristAngleLeft), Math.abs(wristAngleRight)), postureThresholds.wrist_angle_max * 1.5, 30);
                analysis.hands.status = 'Incorrecte';
                analysis.hands.details = `${translations[currentLanguage].details.handsTense}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Back
            const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
            const hipMidX = (leftHip.x + rightHip.x) / 2;
            const hipMidY = (leftHip.y + rightHip.y) / 2;
            const backAngle = (180 / Math.PI) * Math.atan2(hipMidY - shoulderMidY, hipMidX - shoulderMidX);
            analysis.back.position = { shoulder_mid: [shoulderMidX, shoulderMidY], hip_mid: [hipMidX, hipMidY], angle: backAngle };
            if (Math.abs(backAngle) > postureThresholds.back_angle_max) {
                const severity = getSeverityLevel(Math.abs(backAngle), postureThresholds.back_angle_max, 40);
                analysis.back.status = 'Incorrecte';
                analysis.back.details = `${translations[currentLanguage].details.backForward}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (Math.abs(shoulderMidX - hipMidX) > 0.1) {
                const severity = getSeverityLevel(Math.abs(shoulderMidX - hipMidX), postureThresholds.pelvis_misalignment, 0.2);
                analysis.back.status = 'Incorrecte';
                analysis.back.details += analysis.back.details.includes('forward') || analysis.back.details.includes('للأمام') ? ` | ${translations[currentLanguage].details.backTwisted}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.backTwisted}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Pelvis
            const pelvisAlignment = Math.abs(leftHip.x - rightHip.x);
            if (pelvisAlignment > postureThresholds.pelvis_misalignment) {
                const severity = getSeverityLevel(pelvisAlignment, postureThresholds.pelvis_misalignment, 0.2);
                analysis.pelvis.status = 'Incorrecte';
                analysis.pelvis.details = `${translations[currentLanguage].details.pelvisMisaligned}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Thighs
            const thighAngleLeft = calculateVerticalAngle(leftHip, leftKnee);
            const thighAngleRight = calculateVerticalAngle(rightHip, rightKnee);
            if (Math.abs(thighAngleLeft) > postureThresholds.thigh_angle || Math.abs(thighAngleRight) > postureThresholds.thigh_angle) {
                const severity = getSeverityLevel(Math.max(Math.abs(thighAngleLeft), Math.abs(thighAngleRight)), postureThresholds.thigh_angle, 20);
                analysis.thighs.status = 'Incorrecte';
                analysis.thighs.details = `${translations[currentLanguage].details.thighsNotHorizontal}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Knees
            const kneeAngleLeft = calculateAngle(leftHip, leftKnee, leftAnkle);
            const kneeAngleRight = calculateAngle(rightHip, rightKnee, rightAnkle);
            if (kneeAngleLeft < postureThresholds.knee_angle_min || kneeAngleLeft > postureThresholds.knee_angle_max ||
                kneeAngleRight < postureThresholds.knee_angle_min || kneeAngleRight > postureThresholds.knee_angle_max) {
                const severity = getSeverityLevel(Math.min(kneeAngleLeft, kneeAngleRight) < postureThresholds.knee_angle_min ? postureThresholds.knee_angle_min - kneeAngleLeft : kneeAngleLeft - postureThresholds.knee_angle_max, 10, 20);
                analysis.knees.status = 'Incorrecte';
                analysis.knees.details = `${translations[currentLanguage].details.kneesNot90}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Feet
            if (Math.abs(leftAnkle.y - rightAnkle.y) > postureThresholds.feet_height_diff) {
                const severity = getSeverityLevel(Math.abs(leftAnkle.y - rightAnkle.y), postureThresholds.feet_height_diff, 0.2);
                analysis.feet.status = 'Incorrecte';
                analysis.feet.details = `${translations[currentLanguage].details.feetCrossed}${translations[currentLanguage].details.severity[severity]}`;
            }
            if (Math.max(leftAnkle.y, rightAnkle.y) < Math.min(leftHip.y, rightHip.y) - 0.3) {
                const severity = getSeverityLevel(Math.max(leftAnkle.y, rightAnkle.y) - Math.min(leftHip.y, rightHip.y), 0.3, 0.5);
                analysis.feet.status = 'Incorrecte';
                analysis.feet.details += analysis.feet.details.includes('crossed') || analysis.feet.details.includes('متقاطعتان') ? ` | ${translations[currentLanguage].details.feetNotFlat}${translations[currentLanguage].details.severity[severity]}` : `${translations[currentLanguage].details.feetNotFlat}${translations[currentLanguage].details.severity[severity]}`;
            }

            // Global Posture
            const components = ['head', 'neck', 'shoulders', 'arms', 'forearms', 'wrists', 'hands', 'back', 'pelvis', 'thighs', 'knees', 'feet'];
            for (const comp of components) {
                if (analysis[comp].status === 'Incorrecte') {
                    analysis.global_posture = 'Incorrecte';
                    break;
                }
            }

            return analysis;
        }

        function calculateAngle(a, b, c) {
            const ba = [a.x - b.x, a.y - b.y];
            const bc = [c.x - b.x, c.y - b.y];
            const cosineAngle = (ba[0] * bc[0] + ba[1] * bc[1]) / (Math.sqrt(ba[0]**2 + ba[1]**2) * Math.sqrt(bc[0]**2 + bc[1]**2));
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function calculateVerticalAngle(a, b) {
            const vertical = [0, -1];
            const ab = [b.x - a.x, b.y - a.y];
            const cosineAngle = (vertical[0] * ab[0] + vertical[1] * ab[1]) / (Math.sqrt(ab[0]**2 + ab[1]**2));
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function calculateWristAngle(elbow, wrist) {
            const forearmVector = [wrist.x - elbow.x, wrist.y - elbow.y];
            const vertical = [0, 1];
            const cosineAngle = (forearmVector[0] * vertical[0] + forearmVector[1] * vertical[1]) / (Math.sqrt(forearmVector[0]**2 + forearmVector[1]**2));
            return (180 / Math.PI) * Math.acos(Math.min(Math.max(cosineAngle, -1), 1));
        }

        function displayAnalysis(analysis) {
            postureStatus.textContent = analysis.global_posture;
            postureStatus.className = analysis.global_posture === 'Correcte' ? 'status-correct' : 'status-incorrect';

            postureList.innerHTML = '';
            const components = [
                { key: 'head', label: translations[currentLanguage].components.head },
                { key: 'neck', label: translations[currentLanguage].components.neck },
                { key: 'shoulders', label: translations[currentLanguage].components.shoulders },
                { key: 'arms', label: translations[currentLanguage].components.arms },
                { key: 'forearms', label: translations[currentLanguage].components.forearms },
                { key: 'wrists', label: translations[currentLanguage].components.wrists },
                { key: 'hands', label: translations[currentLanguage].components.hands },
                { key: 'back', label: translations[currentLanguage].components.back },
                { key: 'pelvis', label: translations[currentLanguage].components.pelvis },
                { key: 'thighs', label: translations[currentLanguage].components.thighs },
                { key: 'knees', label: translations[currentLanguage].components.knees },
                { key: 'feet', label: translations[currentLanguage].components.feet }
            ];

            for (const { key, label } of components) {
                const li = document.createElement('li');
                li.textContent = `${label}: ${analysis[key].details}`;
                li.className = analysis[key].status === 'Correcte' ? 'status-correct' : 'status-incorrect';
                postureList.appendChild(li);
            }

            postureDetails.classList.remove('hidden');

            if (analysis.back.position) {
                const shoulderMid = analysis.back.position.shoulder_mid;
                const hipMid = analysis.back.position.hip_mid;
                canvasCtx.beginPath();
                canvasCtx.moveTo(shoulderMid[0] * canvasElement.width, shoulderMid[1] * canvasElement.height);
                canvasCtx.lineTo(hipMid[0] * canvasElement.width, hipMid[1] * canvasElement.height);
                canvasCtx.strokeStyle = analysis.back.status === 'Correcte' ? '#4ade80' : '#ff4d4d';
                canvasCtx.lineWidth = 10;
                canvasCtx.stroke();

                const backAngle = analysis.back.position.angle;
                const midPoint = [
                    (shoulderMid[0] * canvasElement.width + hipMid[0] * canvasElement.width) / 2 + 50,
                    (shoulderMid[1] * canvasElement.height + hipMid[1] * canvasElement.height) / 2
                ];
                canvasCtx.fillStyle = '#d4af37';
                canvasCtx.font = '18px Inter';
                canvasCtx.fillText(`Back Angle: ${Math.round(backAngle)}°`, midPoint[0], midPoint[1]);
            }
        }
    </script>
</body>
</html>
